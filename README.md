## TG SQL Analyst — кратко

Телеграм‑бот, который отвечает на вопросы по базе SQLite. Делает это в два шага: генерирует SQL по вопросу и превращает результат в короткую аналитику для Telegram.

### Запуск
- Python 3.10+
- Переменные окружения:
  - `OPENAI_API_KEY` — ключ OpenAI
  - `TELEGRAM_BOT_TOKEN` — токен бота
  - `DB_PATH` — путь к БД (по умолчанию `./leads.db`)
  - `LOG_LEVEL` — уровень логирования (`INFO` по умолчанию)

Запуск бота:

```bash
python bot.py
```

### Как работает
1. Пользователь пишет сообщение в Telegram.
2. `openai_sql_agent.py` формирует SQL (только по таблице `leads`). Контекст соответствий берётся из `projects`.
3. SQL выполняется в режиме read‑only, получаем строки.
4. `openai_analyst_agent.py` превращает строки в краткий ответ + 1–2 инсайта.

### Файлы
- `prompts.py` — системные промпты (SQL‑агент, аналитик)
- `openai_sql_agent.py` — генерация SQL
- `openai_analyst_agent.py` — формирование ответа
- `project_resolver.py` — загрузка маппинга из `projects`
- `inspect_schema.py` — быстрая инспекция схемы БД (read‑only)

### Важные детали БД
- Используется таблица `leads` (только SELECT).
- `project_code` хранится в виде `[LR***]` (со скобками) — такой формат обязателен в фильтрах.
- Поля `unused` и `check_mark` игнорируются, если пользователь явно не просил.

### Логи и безопасность
- Телефоны в логах маскируются в аналитике.
- Логи короткие, без лишнего вывода; сырой ответ модели обрезается.

### Утилиты
- Инспекция БД: `python inspect_schema.py --db <путь>` (опционально `--samples N`).


